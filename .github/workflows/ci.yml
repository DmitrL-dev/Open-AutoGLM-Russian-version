name: CI/CD

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    lint:
        name: Lint & Type Check
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install dependencies
              run: |
                  pip install ruff mypy
                  pip install -e .
                  pip install pydantic fastapi

            - name: Run Ruff linter
              run: ruff check phone_agent/ --ignore E501

            - name: Run type check
              run: mypy phone_agent/ --ignore-missing-imports --no-error-summary || true

    test:
        name: Tests
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install dependencies
              run: |
                  pip install pytest pytest-cov
                  pip install -e .
                  pip install pydantic fastapi

            - name: Run tests
              run: pytest tests/ -v --cov=phone_agent --cov-report=xml

            - name: Upload coverage
              uses: codecov/codecov-action@v3
              with:
                  files: coverage.xml
              continue-on-error: true

    security:
        name: Security Scan
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install Bandit
              run: pip install bandit

            - name: Run security scan
              run: bandit -r phone_agent/ -ll --skip B101

    docker:
        name: Docker Build
        runs-on: ubuntu-latest
        needs: [lint, test]
        if: github.ref == 'refs/heads/main'
        steps:
            - uses: actions/checkout@v4

            - name: Build Docker image
              run: docker build -t phone-agent:latest .

            - name: Test Docker image
              run: docker run --rm phone-agent:latest python -c "from phone_agent import PhoneAgent; print('OK')"
